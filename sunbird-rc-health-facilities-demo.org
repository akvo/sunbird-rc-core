#+TITLE: Sunbird RC - Health Facilities Registry Demo
#+AUTHOR:
#+DATE: 2025-12-10
#+PROPERTY: header-args:python :session *sunbird-health* :results output :exports both
#+STARTUP: overview indent

* New Registry Creation Demo

This document demonstrates the *complete workflow* for creating a new registry in Sunbird RC, using Health Facilities as an example.

#+BEGIN_QUOTE
*What You'll Learn:*
- How to design and create a JSON Schema for a custom entity
- How to deploy schemas to Sunbird RC
- Complete CRUD operations (Create, Read, Update, Delete)
- Search and filter capabilities
- Bulk operations and data export
- Statistical analysis of registry data

*Entity Type:* Health Facilities (hospitals, clinics, diagnostic centers)
*Fields:* 20+ including staff capacity, services, location, accreditation
*Operations:* 15 complete working examples
#+END_QUOTE

** Quick Start Guide

To create a new registry in Sunbird RC:

1. *Execute blocks in order* (C-c C-c on each block in Emacs)
   - Start with Setup
   - Create schema definition
   - Deploy schema file
   - Restart registry
   - Verify and start using!

2. *Key Steps*:
   - Section 2: Create the JSON Schema
   - Section 4: Deploy schema to file system
   - Section 5: Restart registry service
   - Section 6: Verify schema is loaded
   - Section 7+: Create and manage entities

3. *Adapt for Your Use Case*:
   - Replace "HealthFacility" with your entity name
   - Modify schema fields to match your needs
   - Adjust the sample data in sections 7-13

** Prerequisites
- Sunbird RC services running (use =./start-sunbird.sh=)
- Registry API available at http://localhost:8081
- Write access to schema directory (or Docker volume)

** About This Registry

This registry tracks health facilities with the following attributes:
- Facility name and registration number
- Type of facility (Government, Private, NGO)
- Director information
- Staff capacity (officers, doctors, nurses)
- Operational details (beds, specializations, services)
- Location and contact information

* Setup

#+NAME: setup
#+begin_src python
import requests
import json
import pandas as pd
from datetime import datetime

# Configuration
BASE_URL = "http://localhost:8081/api/v1"
SCHEMA_URL = "http://localhost:8081/api/docs/swagger.json"
HEADERS = {"Content-Type": "application/json"}

print("‚úÖ Health Facilities Registry - Setup complete!")
print(f"Registry API: {BASE_URL}")
#+end_src

#+RESULTS: setup
: ‚úÖ Health Facilities Registry - Setup complete!
: Registry API: http://localhost:8081/api/v1

* 1. Check Registry Health

#+NAME: check-health
#+begin_src python
response = requests.get("http://localhost:8081/health")
health = response.json()

print(f"Status: {health['result']['healthy']}")
print(f"Service: {health['result']['name']}")
print("\nRegistry is ready!")
#+end_src

#+RESULTS: check-health
: Status: True
: Service: sunbirdrc-registry-api
:
: Registry is ready!

* 2. Create HealthFacility Schema

First, we need to create the schema definition for HealthFacility. In Sunbird RC, schemas are typically defined in JSON Schema format and need to be added to the registry configuration.


** Understanding Schema Location

Sunbird RC schemas are defined in configuration files. Let's check where schemas should be added:

#+NAME: check-schema-location
#+begin_src python
import os

# Common schema locations in Sunbird RC
schema_paths = [
    "./java/registry/src/main/resources/public/_schemas",
    "./schemas",
    "../schemas"
]

print("Schema Configuration in Sunbird RC:")
print("=" * 80)
print("\nSchemas are typically stored in:")
print("  - java/registry/src/main/resources/public/_schemas/")
print("\nWe need to create a HealthFacility.json schema file.")
print("\nLet's create the schema definition...")
#+end_src

#+RESULTS: check-schema-location
: Schema Configuration in Sunbird RC:
: ================================================================================
:
: Schemas are typically stored in:
:   - java/registry/src/main/resources/public/_schemas/
:
: We need to create a HealthFacility.json schema file.
:
: Let's create the schema definition...

** Create HealthFacility Schema File

#+NAME: create-schema-definition
#+begin_src python
# Define the HealthFacility schema (matching Sunbird RC structure)
health_facility_schema = {
    "$schema": "http://json-schema.org/draft-07/schema",
    "type": "object",
    "properties": {
        "HealthFacility": {
            "$ref": "#/definitions/HealthFacility"
        }
    },
    "required": ["HealthFacility"],
    "title": "HealthFacility",
    "definitions": {
        "HealthFacility": {
            "$id": "#/properties/HealthFacility",
            "type": "object",
            "title": "Health Facility Registry",
            "description": "Schema for health facilities including hospitals, clinics, and diagnostic centers",
            "required": ["facilityName", "registrationNumber", "facilityType", "directorName"],
            "properties": {
                "facilityName": {
                    "type": "string",
                    "description": "Name of the health facility"
                },
                "registrationNumber": {
                    "type": "string",
                    "description": "Unique registration number"
                },
                "facilityType": {
                    "type": "string",
                    "enum": ["Government", "Private", "NGO"],
                    "description": "Type of facility ownership"
                },
                "subType": {
                    "type": "string",
                    "description": "Specific type of health facility (e.g., Hospital, Clinic, Diagnostic Center)"
                },
                "directorName": {
                    "type": "string",
                    "description": "Name of the facility director"
                },
                "directorQualification": {
                    "type": "string",
                    "description": "Qualifications of the director"
                },
                "numberOfOfficers": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Number of administrative officers"
                },
                "numberOfDoctors": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Number of doctors"
                },
                "numberOfNurses": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Number of nurses"
                },
                "numberOfBeds": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Total bed capacity"
                },
                "hasEmergency": {
                    "type": "boolean",
                    "description": "Whether facility has emergency services"
                },
                "hasICU": {
                    "type": "boolean",
                    "description": "Whether facility has ICU"
                },
                "icuBeds": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Number of ICU beds"
                },
                "specializations": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "Medical specializations available"
                },
                "services": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "Services offered"
                },
                "address": {
                    "type": "object",
                    "properties": {
                        "street": {"type": "string"},
                        "city": {"type": "string"},
                        "state": {"type": "string"},
                        "postalCode": {"type": "string"},
                        "country": {"type": "string"}
                    }
                },
                "contactPhone": {
                    "type": "string",
                    "description": "Primary contact phone number"
                },
                "contactEmail": {
                    "type": "string",
                    "format": "email",
                    "description": "Primary contact email"
                },
                "establishedYear": {
                    "type": "integer",
                    "minimum": 1800,
                    "maximum": 2100,
                    "description": "Year the facility was established"
                },
                "accreditation": {
                    "type": "string",
                    "description": "Accreditation status (e.g., NABH, JCI)"
                },
                "operatingHours": {
                    "type": "string",
                    "description": "Operating hours of the facility"
                },
                "website": {
                    "type": "string",
                    "format": "uri",
                    "description": "Website URL"
                }
            }
        }
    },
    "_osConfig": {
        "privateFields": [],
        "signedFields": [],
        "indexFields": ["registrationNumber", "facilityType", "city", "state"],
        "uniqueIndexFields": ["registrationNumber"],
        "systemFields": ["osCreatedAt", "osUpdatedAt", "osCreatedBy", "osUpdatedBy"],
        "roles": ["admin"],
        "inviteRoles": ["anonymous"],
        "ownershipAttributes": []
    }
}

# Save schema to file
schema_filename = "HealthFacility.json"
with open(schema_filename, 'w') as f:
    json.dump(health_facility_schema, f, indent=2)

print("‚úÖ HealthFacility schema definition created!")
print(f"Schema file: {schema_filename}")
print("\nSchema Structure:")
print("=" * 80)
print(json.dumps(health_facility_schema, indent=2))
#+end_src

#+RESULTS: create-schema-definition
#+begin_example
‚úÖ HealthFacility schema definition created!
Schema file: HealthFacility.json

Schema Structure:
================================================================================
{
  "$schema": "http://json-schema.org/draft-07/schema",
  "type": "object",
  "properties": {
    "HealthFacility": {
      "type": "object",
      "required": [
        "facilityName",
        "registrationNumber",
        "facilityType",
        "directorName"
      ],
      "properties": {
        "facilityName": {
          "type": "string",
          "description": "Name of the health facility"
        },
        "registrationNumber": {
          "type": "string",
          "description": "Unique registration number"
        },
        "facilityType": {
          "type": "string",
          "enum": [
            "Government",
            "Private",
            "NGO"
          ],
          "description": "Type of facility ownership"
        },
        "subType": {
          "type": "string",
          "description": "Specific type of health facility (e.g., Hospital, Clinic, Diagnostic Center)"
        },
        "directorName": {
          "type": "string",
          "description": "Name of the facility director"
        },
        "directorQualification": {
          "type": "string",
          "description": "Qualifications of the director"
        },
        "numberOfOfficers": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of administrative officers"
        },
        "numberOfDoctors": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of doctors"
        },
        "numberOfNurses": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of nurses"
        },
        "numberOfBeds": {
          "type": "integer",
          "minimum": 0,
          "description": "Total bed capacity"
        },
        "hasEmergency": {
          "type": "boolean",
          "description": "Whether facility has emergency services"
        },
        "hasICU": {
          "type": "boolean",
          "description": "Whether facility has ICU"
        },
        "icuBeds": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of ICU beds"
        },
        "specializations": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Medical specializations available"
        },
        "services": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Services offered"
        },
        "address": {
          "type": "object",
          "properties": {
            "street": {
              "type": "string"
            },
            "city": {
              "type": "string"
            },
            "state": {
              "type": "string"
            },
            "postalCode": {
              "type": "string"
            },
            "country": {
              "type": "string"
            }
          }
        },
        "contactPhone": {
          "type": "string",
          "description": "Primary contact phone number"
        },
        "contactEmail": {
          "type": "string",
          "format": "email",
          "description": "Primary contact email"
        },
        "establishedYear": {
          "type": "integer",
          "minimum": 1800,
          "maximum": 2100,
          "description": "Year the facility was established"
        },
        "accreditation": {
          "type": "string",
          "description": "Accreditation status (e.g., NABH, JCI)"
        },
        "operatingHours": {
          "type": "string",
          "description": "Operating hours of the facility"
        },
        "website": {
          "type": "string",
          "format": "uri",
          "description": "Website URL"
        }
      }
    }
  },
  "required": [
    "HealthFacility"
  ]
}
#+end_example

** Deploy Schema to Sunbird RC

#+NAME: deploy-schema-instructions
#+begin_src python
print("üìã Steps to Deploy HealthFacility Schema to Sunbird RC:")
print("=" * 80)
print()
print("1. Copy the schema file to the schemas directory:")
print("   cp HealthFacility.json java/registry/src/main/resources/public/_schemas/")
print()
print("2. Or if using Docker volumes, copy to the mounted schemas directory")
print()
print("3. Restart the registry service to load the new schema:")
print("   docker-compose restart registry")
print()
print("4. Alternatively, if schemas are hot-reloadable, the API should")
print("   automatically detect the new schema")
print()
print("=" * 80)
print("NOTE: The exact deployment method depends on your Sunbird RC setup.")
print("For this demo, we'll attempt to check if the schema is available...")
#+end_src

** Alternative: Check Existing Schemas

#+NAME: list-available-schemas
#+begin_src python
# Try to get the list of available schemas
try:
    # Method 1: Check Swagger/OpenAPI documentation
    swagger_response = requests.get("http://localhost:8081/api/docs/swagger.json")
    if swagger_response.status_code == 200:
        swagger_data = swagger_response.json()
        print("Available Schemas from Swagger:")
        print("=" * 80)

        if 'definitions' in swagger_data:
            schemas = list(swagger_data['definitions'].keys())
            for schema in schemas:
                print(f"  - {schema}")
        elif 'components' in swagger_data and 'schemas' in swagger_data['components']:
            schemas = list(swagger_data['components']['schemas'].keys())
            for schema in schemas:
                print(f"  - {schema}")
        else:
            print("  No schema definitions found in Swagger")
    else:
        print(f"Could not retrieve Swagger documentation: {swagger_response.status_code}")

except Exception as e:
    print(f"Error retrieving schemas: {str(e)}")

print("\n" + "=" * 80)
print("To use custom schemas, you need to:")
print("1. Define the schema in JSON Schema format")
print("2. Place it in the schemas directory")
print("3. Restart the registry service")
#+end_src


* 3. Verify Schema is Available

#+NAME: verify-schema
#+begin_src python
# Try to verify if HealthFacility schema is available
# We'll attempt a simple GET request to see if the endpoint exists

try:
    response = requests.get(f"{BASE_URL}/HealthFacility", headers=HEADERS)

    if response.status_code == 200:
        print("‚úÖ HealthFacility schema is available!")
        print(f"Response: {response.json()}")
    elif response.status_code == 404:
        print("‚ùå HealthFacility schema not found")
        print("\nYou need to:")
        print("1. Copy HealthFacility.json to: java/registry/src/main/resources/public/_schemas/")
        print("2. Restart the registry: docker-compose restart registry")
        print("\nOr use the existing DegreeCertificate schema for this demo")
    else:
        print(f"Response code: {response.status_code}")
        print(f"Response: {response.text}")
except Exception as e:
    print(f"Error: {str(e)}")
#+end_src

* 4. Deploy Schema File

Now we need to copy the schema to the correct location and restart the registry.

#+NAME: deploy-schema-file
#+begin_src sh :dir /home/dedenbangkit/Repos/forks/sunbird-rc-core
# Find the schemas directory
echo "Looking for schemas directory..."

if [ -d "java/registry/src/main/resources/public/_schemas" ]; then
    echo "‚úÖ Found schemas directory"
    echo "Copying HealthFacility.json to schemas directory..."
    cp HealthFacility.json java/registry/src/main/resources/public/_schemas/
    echo "‚úÖ Schema file copied"
    echo ""
    echo "Schema files in directory:"
    ls -la java/registry/src/main/resources/public/_schemas/
else
    echo "‚ùå Schemas directory not found at expected location"
    echo "Please manually copy HealthFacility.json to your schemas directory"
fi
#+end_src

* 5. Restart Registry to Load Schema

#+NAME: restart-registry
#+begin_src sh :dir /home/dedenbangkit/Repos/forks/sunbird-rc-core
echo "Restarting registry service to load new schema..."
docker-compose restart registry

echo ""
echo "Waiting for registry to be ready..."
sleep 5

echo "‚úÖ Registry restarted"
echo ""
echo "You can now use the HealthFacility schema!"
#+end_src

* 6. Verify Schema Deployment

#+NAME: verify-schema-deployment
#+begin_src python
import time

print("Verifying HealthFacility schema deployment...")
print("=" * 80)

# Give registry time to fully start
time.sleep(2)

try:
    response = requests.get(f"{BASE_URL}/HealthFacility", headers=HEADERS)

    if response.status_code == 200:
        data = response.json()
        print("‚úÖ HealthFacility schema is now available!")
        print(f"Total facilities: {data.get('totalCount', 0)}")
    else:
        print(f"‚ùå Schema verification failed: {response.status_code}")
        print(f"Response: {response.text}")
        print("\nIf schema is not available, you may need to:")
        print("1. Check that HealthFacility.json is in the schemas directory")
        print("2. Check registry logs: docker-compose logs registry")
        print("3. Ensure the schema follows the correct format")
except Exception as e:
    print(f"‚ùå Error: {str(e)}")
#+end_src

* 7. Create Sample Health Facilities

** 7.1 Government Hospital

#+NAME: create-govt-hospital
#+begin_src python
govt_hospital = {
    "facilityName": "City General Hospital",
    "registrationNumber": "HF-GOV-2024-001",
    "facilityType": "Government",
    "subType": "Tertiary Hospital",
    "directorName": "Dr. Rajesh Kumar",
    "directorQualification": "MD, FRCS",
    "numberOfOfficers": 45,
    "numberOfDoctors": 120,
    "numberOfNurses": 250,
    "numberOfBeds": 500,
    "hasEmergency": True,
    "hasICU": True,
    "icuBeds": 50,
    "specializations": [
        "Cardiology",
        "Neurology",
        "Orthopedics",
        "Pediatrics",
        "General Surgery",
        "Oncology"
    ],
    "services": [
        "24x7 Emergency",
        "Ambulance Service",
        "Blood Bank",
        "Diagnostic Lab",
        "Pharmacy",
        "Radiology"
    ],
    "address": {
        "street": "123 Main Road",
        "city": "Mumbai",
        "state": "Maharashtra",
        "postalCode": "400001",
        "country": "India"
    },
    "contactPhone": "+91-22-12345678",
    "contactEmail": "admin@citygeneralhospital.gov.in",
    "establishedYear": 1985,
    "accreditation": "NABH",
    "operatingHours": "24x7",
    "website": "https://citygeneralhospital.gov.in"
}

response = requests.post(
    f"{BASE_URL}/HealthFacility",
    headers=HEADERS,
    json=govt_hospital
)

if response.status_code == 200:
    result = response.json()
    print("‚úÖ Government Hospital created successfully!")
    print(f"Facility ID: {result['result']['HealthFacility']['osid']}")
    print(f"Name: {govt_hospital['facilityName']}")
    print(f"Type: {govt_hospital['facilityType']} - {govt_hospital['subType']}")
    print(f"Director: {govt_hospital['directorName']}")
    print(f"Capacity: {govt_hospital['numberOfBeds']} beds")
    print(f"Staff: {govt_hospital['numberOfDoctors']} doctors, {govt_hospital['numberOfNurses']} nurses")
else:
    print(f"‚ùå Error: {response.status_code}")
    print(response.text)
#+end_src

** 7.2 Private Multi-Specialty Hospital

#+NAME: create-private-hospital
#+begin_src python
private_hospital = {
    "facilityName": "MedCare Advanced Hospital",
    "registrationNumber": "HF-PVT-2024-002",
    "facilityType": "Private",
    "subType": "Multi-Specialty Hospital",
    "directorName": "Dr. Priya Sharma",
    "directorQualification": "MBBS, MS, MBA (Healthcare)",
    "numberOfOfficers": 35,
    "numberOfDoctors": 85,
    "numberOfNurses": 180,
    "numberOfBeds": 350,
    "hasEmergency": True,
    "hasICU": True,
    "icuBeds": 40,
    "specializations": [
        "Cardiology",
        "Nephrology",
        "Gastroenterology",
        "Orthopedics",
        "Dermatology",
        "ENT",
        "Ophthalmology"
    ],
    "services": [
        "24x7 Emergency",
        "Ambulance Service",
        "Blood Bank",
        "Diagnostic Lab",
        "Pharmacy",
        "CT Scan",
        "MRI",
        "Dialysis Unit"
    ],
    "address": {
        "street": "45 Healthcare Avenue",
        "city": "Bangalore",
        "state": "Karnataka",
        "postalCode": "560001",
        "country": "India"
    },
    "contactPhone": "+91-80-87654321",
    "contactEmail": "info@medcarehospital.com",
    "establishedYear": 2010,
    "accreditation": "NABH, JCI",
    "operatingHours": "24x7",
    "website": "https://medcarehospital.com"
}

response = requests.post(
    f"{BASE_URL}/HealthFacility",
    headers=HEADERS,
    json=private_hospital
)

if response.status_code == 200:
    result = response.json()
    print("‚úÖ Private Hospital created successfully!")
    print(f"Facility ID: {result['result']['HealthFacility']['osid']}")
    print(f"Name: {private_hospital['facilityName']}")
    print(f"Type: {private_hospital['facilityType']} - {private_hospital['subType']}")
    print(f"Director: {private_hospital['directorName']}")
    print(f"Capacity: {private_hospital['numberOfBeds']} beds")
    print(f"Accreditation: {private_hospital['accreditation']}")
else:
    print(f"‚ùå Error: {response.status_code}")
    print(response.text)
#+end_src

** 7.3 NGO Primary Health Center

#+NAME: create-ngo-clinic
#+begin_src python
ngo_clinic = {
    "facilityName": "Hope Foundation Health Center",
    "registrationNumber": "HF-NGO-2024-003",
    "facilityType": "NGO",
    "subType": "Primary Health Center",
    "directorName": "Dr. Anil Verma",
    "directorQualification": "MBBS, MPH",
    "numberOfOfficers": 8,
    "numberOfDoctors": 12,
    "numberOfNurses": 25,
    "numberOfBeds": 30,
    "hasEmergency": False,
    "hasICU": False,
    "icuBeds": 0,
    "specializations": [
        "General Medicine",
        "Pediatrics",
        "Gynecology",
        "Community Health"
    ],
    "services": [
        "OPD Services",
        "Vaccination",
        "Maternal Health",
        "Child Health",
        "Basic Lab",
        "Pharmacy",
        "Health Education"
    ],
    "address": {
        "street": "Rural Road, Village Khandala",
        "city": "Pune",
        "state": "Maharashtra",
        "postalCode": "410301",
        "country": "India"
    },
    "contactPhone": "+91-20-11223344",
    "contactEmail": "contact@hopefoundation.org",
    "establishedYear": 2015,
    "accreditation": "ISO 9001",
    "operatingHours": "8:00 AM - 6:00 PM",
    "website": "https://hopefoundation.org"
}

response = requests.post(
    f"{BASE_URL}/HealthFacility",
    headers=HEADERS,
    json=ngo_clinic
)

if response.status_code == 200:
    result = response.json()
    print("‚úÖ NGO Health Center created successfully!")
    print(f"Facility ID: {result['result']['HealthFacility']['osid']}")
    print(f"Name: {ngo_clinic['facilityName']}")
    print(f"Type: {ngo_clinic['facilityType']} - {ngo_clinic['subType']}")
    print(f"Director: {ngo_clinic['directorName']}")
    print(f"Focus: Community Health & Primary Care")
    print(f"Operating Hours: {ngo_clinic['operatingHours']}")
else:
    print(f"‚ùå Error: {response.status_code}")
    print(response.text)
#+end_src

** 7.4 Private Diagnostic Center

#+NAME: create-diagnostic-center
#+begin_src python
diagnostic_center = {
    "facilityName": "QuickDiag Medical Diagnostics",
    "registrationNumber": "HF-PVT-2024-004",
    "facilityType": "Private",
    "subType": "Diagnostic Center",
    "directorName": "Dr. Meera Patel",
    "directorQualification": "MD (Pathology), PhD",
    "numberOfOfficers": 15,
    "numberOfDoctors": 8,
    "numberOfNurses": 12,
    "numberOfBeds": 0,
    "hasEmergency": False,
    "hasICU": False,
    "icuBeds": 0,
    "specializations": [
        "Pathology",
        "Radiology",
        "Cardiology Diagnostics"
    ],
    "services": [
        "Blood Tests",
        "X-Ray",
        "Ultrasound",
        "ECG",
        "CT Scan",
        "MRI",
        "Endoscopy",
        "Home Sample Collection"
    ],
    "address": {
        "street": "15 Medical Plaza",
        "city": "Delhi",
        "state": "Delhi",
        "postalCode": "110001",
        "country": "India"
    },
    "contactPhone": "+91-11-99887766",
    "contactEmail": "info@quickdiag.in",
    "establishedYear": 2018,
    "accreditation": "NABL",
    "operatingHours": "7:00 AM - 10:00 PM",
    "website": "https://quickdiag.in"
}

response = requests.post(
    f"{BASE_URL}/HealthFacility",
    headers=HEADERS,
    json=diagnostic_center
)

if response.status_code == 200:
    result = response.json()
    print("‚úÖ Diagnostic Center created successfully!")
    print(f"Facility ID: {result['result']['HealthFacility']['osid']}")
    print(f"Name: {diagnostic_center['facilityName']}")
    print(f"Type: {diagnostic_center['facilityType']} - {diagnostic_center['subType']}")
    print(f"Director: {diagnostic_center['directorName']}")
    print(f"Services: {len(diagnostic_center['services'])} diagnostic services")
    print(f"Accreditation: {diagnostic_center['accreditation']}")
else:
    print(f"‚ùå Error: {response.status_code}")
    print(response.text)
#+end_src

* 8. List All Health Facilities

#+NAME: list-facilities
#+begin_src python
response = requests.get(f"{BASE_URL}/HealthFacility", headers=HEADERS)
data = response.json()

print(f"Total Health Facilities: {data['totalCount']}\n")

if data['totalCount'] > 0:
    df = pd.DataFrame(data['data'])
    columns = ['facilityName', 'facilityType', 'subType', 'directorName',
               'numberOfDoctors', 'numberOfBeds', 'city', 'state']

    # Filter to only include columns that exist
    available_columns = [col for col in columns if col in df.columns]

    print("Health Facilities Registry:")
    print("=" * 100)
    print(df[available_columns].to_string(index=False))
else:
    print("No health facilities found")
#+end_src

* 9. Search Facilities by Type

** 9.1 Search Government Facilities

#+NAME: search-government
#+begin_src python
search_query = {
    "filters": {
        "facilityType": {"eq": "Government"}
    }
}

response = requests.post(
    f"{BASE_URL}/HealthFacility/search",
    headers=HEADERS,
    json=search_query
)

if response.status_code == 200:
    results = response.json()
    print(f"Search Query: facilityType = 'Government'")
    print(f"Found {results['totalCount']} government facilities\n")

    if results['totalCount'] > 0:
        df = pd.DataFrame(results['data'])
        print("Government Health Facilities:")
        print("=" * 80)
        display_cols = ['facilityName', 'subType', 'directorName', 'numberOfBeds', 'city']
        available_cols = [col for col in display_cols if col in df.columns]
        print(df[available_cols].to_string(index=False))
    else:
        print("No government facilities found")
else:
    print(f"‚ùå Error: {response.status_code}")
    print(response.text)
#+end_src

** 9.2 Search Private Facilities

#+NAME: search-private
#+begin_src python
search_query = {
    "filters": {
        "facilityType": {"eq": "Private"}
    }
}

response = requests.post(
    f"{BASE_URL}/HealthFacility/search",
    headers=HEADERS,
    json=search_query
)

if response.status_code == 200:
    results = response.json()
    print(f"Search Query: facilityType = 'Private'")
    print(f"Found {results['totalCount']} private facilities\n")

    if results['totalCount'] > 0:
        df = pd.DataFrame(results['data'])
        print("Private Health Facilities:")
        print("=" * 80)
        display_cols = ['facilityName', 'subType', 'accreditation', 'numberOfBeds', 'city']
        available_cols = [col for col in display_cols if col in df.columns]
        print(df[available_cols].to_string(index=False))
    else:
        print("No private facilities found")
else:
    print(f"‚ùå Error: {response.status_code}")
    print(response.text)
#+end_src

** 9.3 Search Facilities with ICU

#+NAME: search-icu-facilities
#+begin_src python
search_query = {
    "filters": {
        "hasICU": {"eq": True}
    }
}

response = requests.post(
    f"{BASE_URL}/HealthFacility/search",
    headers=HEADERS,
    json=search_query
)

if response.status_code == 200:
    results = response.json()
    print(f"Search Query: hasICU = True")
    print(f"Found {results['totalCount']} facilities with ICU\n")

    if results['totalCount'] > 0:
        df = pd.DataFrame(results['data'])
        print("Facilities with ICU:")
        print("=" * 80)
        display_cols = ['facilityName', 'facilityType', 'icuBeds', 'numberOfBeds', 'city']
        available_cols = [col for col in display_cols if col in df.columns]
        print(df[available_cols].to_string(index=False))
    else:
        print("No facilities with ICU found")
else:
    print(f"‚ùå Error: {response.status_code}")
    print(response.text)
#+end_src

* 10. Get Facility Details by ID

#+NAME: get-facility-details
#+begin_src python
# Get the first facility's ID
response = requests.get(f"{BASE_URL}/HealthFacility")
facilities = response.json()['data']

if facilities:
    facility_id = facilities[0]['osid']
    print(f"Fetching facility: {facilities[0].get('facilityName', 'Unknown')}")
    print(f"ID: {facility_id}\n")

    response = requests.get(f"{BASE_URL}/HealthFacility/{facility_id}")
    facility = response.json()

    print("Facility Details:")
    print("=" * 80)
    print(json.dumps(facility, indent=2))
else:
    print("No facilities available")
#+end_src

* 11. Update Facility Information

#+NAME: update-facility
#+begin_src python
# Get first facility
response = requests.get(f"{BASE_URL}/HealthFacility")
facilities = response.json()['data']

if facilities:
    facility_id = facilities[0]['osid']
    facility_name = facilities[0].get('facilityName', 'Unknown')
    print(f"Updating facility: {facility_name}")
    print(f"ID: {facility_id}\n")

    # Update the facility - add more doctors and nurses
    update_data = facilities[0].copy()
    old_doctors = update_data.get('numberOfDoctors', 0)
    old_nurses = update_data.get('numberOfNurses', 0)

    update_data['numberOfDoctors'] = old_doctors + 5
    update_data['numberOfNurses'] = old_nurses + 10
    update_data['accreditation'] = 'NABH, JCI'

    print(f"Changes:")
    print(f"  - Doctors: {old_doctors} ‚Üí {update_data['numberOfDoctors']}")
    print(f"  - Nurses: {old_nurses} ‚Üí {update_data['numberOfNurses']}")
    print(f"  - Accreditation updated to: {update_data['accreditation']}\n")

    response = requests.put(
        f"{BASE_URL}/HealthFacility/{facility_id}",
        headers=HEADERS,
        json=update_data
    )

    if response.status_code == 200:
        print("‚úÖ Facility updated successfully!")
        result = response.json()
        print(json.dumps(result, indent=2))
    else:
        print(f"‚ùå Error: {response.status_code}")
        print(response.text)
else:
    print("No facilities available to update")
#+end_src

* 12. Statistics & Analytics

#+NAME: facility-statistics
#+begin_src python
response = requests.get(f"{BASE_URL}/HealthFacility")
data = response.json()

if data['totalCount'] > 0:
    df = pd.DataFrame(data['data'])

    print("üìä Health Facilities Statistics")
    print("=" * 80)
    print(f"\nTotal Facilities: {len(df)}")

    if 'numberOfBeds' in df.columns:
        print(f"Total Bed Capacity: {df['numberOfBeds'].sum():,}")
        print(f"Average Beds per Facility: {df['numberOfBeds'].mean():.1f}")

    if 'numberOfDoctors' in df.columns:
        print(f"Total Doctors: {df['numberOfDoctors'].sum():,}")
        print(f"Average Doctors per Facility: {df['numberOfDoctors'].mean():.1f}")

    if 'numberOfNurses' in df.columns:
        print(f"Total Nurses: {df['numberOfNurses'].sum():,}")

    if 'numberOfOfficers' in df.columns:
        print(f"Total Officers: {df['numberOfOfficers'].sum():,}")

    if 'facilityType' in df.columns:
        print(f"\nFacility Type Distribution:")
        print("-" * 40)
        for ftype, count in df['facilityType'].value_counts().items():
            print(f"  {ftype}: {count}")

    if 'subType' in df.columns:
        print(f"\nFacility Sub-Type Distribution:")
        print("-" * 40)
        for subtype, count in df['subType'].value_counts().items():
            print(f"  {subtype}: {count}")

    if 'state' in df.columns:
        print(f"\nState-wise Distribution:")
        print("-" * 40)
        for state, count in df['state'].value_counts().items():
            print(f"  {state}: {count}")

    if 'hasICU' in df.columns:
        icu_count = df['hasICU'].sum()
        print(f"\nFacilities with ICU: {icu_count}/{len(df)}")
        if 'icuBeds' in df.columns:
            total_icu_beds = df['icuBeds'].sum()
            print(f"Total ICU Beds: {total_icu_beds}")

    if 'hasEmergency' in df.columns:
        emergency_count = df['hasEmergency'].sum()
        print(f"Facilities with Emergency: {emergency_count}/{len(df)}")

else:
    print("No data available for statistics")
#+end_src

#+NAME: bed-capacity-analysis
#+begin_src python
response = requests.get(f"{BASE_URL}/HealthFacility")
data = response.json()

if data['totalCount'] > 0:
    df = pd.DataFrame(data['data'])

    if 'numberOfBeds' in df.columns and 'facilityType' in df.columns:
        print("\nüìä Bed Capacity Analysis by Facility Type")
        print("=" * 80)

        bed_analysis = df.groupby('facilityType').agg({
            'numberOfBeds': ['sum', 'mean', 'max', 'min'],
            'facilityName': 'count'
        }).round(1)

        print(bed_analysis.to_string())
#+end_src

* 13. Bulk Operations

#+NAME: bulk-create-clinics
#+begin_src python
# Create multiple small clinics
bulk_facilities = [
    {
        "facilityName": "Community Health Clinic - East",
        "registrationNumber": "HF-NGO-2024-005",
        "facilityType": "NGO",
        "subType": "Community Clinic",
        "directorName": "Dr. Suresh Reddy",
        "directorQualification": "MBBS",
        "numberOfOfficers": 3,
        "numberOfDoctors": 4,
        "numberOfNurses": 6,
        "numberOfBeds": 10,
        "hasEmergency": False,
        "hasICU": False,
        "icuBeds": 0,
        "address": {"city": "Chennai", "state": "Tamil Nadu", "country": "India"},
        "contactPhone": "+91-44-11111111",
        "contactEmail": "east@communityclinic.org"
    },
    {
        "facilityName": "LifeCare Polyclinic",
        "registrationNumber": "HF-PVT-2024-006",
        "facilityType": "Private",
        "subType": "Polyclinic",
        "directorName": "Dr. Kavita Nair",
        "directorQualification": "MBBS, MD",
        "numberOfOfficers": 5,
        "numberOfDoctors": 8,
        "numberOfNurses": 10,
        "numberOfBeds": 15,
        "hasEmergency": False,
        "hasICU": False,
        "icuBeds": 0,
        "address": {"city": "Kochi", "state": "Kerala", "country": "India"},
        "contactPhone": "+91-484-22222222",
        "contactEmail": "info@lifecarepolyclinic.com"
    },
    {
        "facilityName": "District Government Hospital",
        "registrationNumber": "HF-GOV-2024-007",
        "facilityType": "Government",
        "subType": "District Hospital",
        "directorName": "Dr. Amit Singh",
        "directorQualification": "MBBS, MD, DM",
        "numberOfOfficers": 25,
        "numberOfDoctors": 60,
        "numberOfNurses": 120,
        "numberOfBeds": 200,
        "hasEmergency": True,
        "hasICU": True,
        "icuBeds": 20,
        "address": {"city": "Jaipur", "state": "Rajasthan", "country": "India"},
        "contactPhone": "+91-141-33333333",
        "contactEmail": "admin@districthosp.gov.in"
    }
]

print(f"Creating {len(bulk_facilities)} health facilities...")
print("=" * 80)

results = []
for i, facility in enumerate(bulk_facilities, 1):
    response = requests.post(
        f"{BASE_URL}/HealthFacility",
        headers=HEADERS,
        json=facility
    )

    if response.status_code == 200:
        result = response.json()
        osid = result['result']['HealthFacility']['osid']
        print(f"‚úÖ {i}. Created: {facility['facilityName']}")
        print(f"   Type: {facility['facilityType']} | City: {facility['address']['city']}")
        results.append({'status': 'success', 'osid': osid, 'name': facility['facilityName']})
    else:
        print(f"‚ùå {i}. Failed: {facility['facilityName']} - {response.status_code}")
        results.append({'status': 'failed', 'name': facility['facilityName']})

success_count = len([r for r in results if r['status'] == 'success'])
failed_count = len([r for r in results if r['status'] == 'failed'])

print("\n" + "=" * 80)
print(f"Summary:")
print(f"  ‚úÖ Created: {success_count} facilities")
print(f"  ‚ùå Failed: {failed_count} facilities")
#+end_src

* 14. Export to CSV

#+NAME: export-facilities-csv
#+begin_src python
response = requests.get(f"{BASE_URL}/HealthFacility")
data = response.json()

if data['totalCount'] > 0:
    df = pd.DataFrame(data['data'])

    # Select columns to export
    base_columns = [
        'facilityName', 'registrationNumber', 'facilityType', 'subType',
        'directorName', 'numberOfOfficers', 'numberOfDoctors', 'numberOfNurses',
        'numberOfBeds', 'hasEmergency', 'hasICU', 'icuBeds',
        'contactPhone', 'contactEmail', 'accreditation', 'osid', 'osCreatedAt'
    ]

    # Only include columns that exist
    export_columns = [col for col in base_columns if col in df.columns]

    filename = f'health_facilities_{datetime.now().strftime("%Y%m%d_%H%M%S")}.csv'
    df[export_columns].to_csv(filename, index=False)

    print(f"‚úÖ Exported {len(df)} health facilities to: {filename}")
    print("\nPreview (first 5 rows):")
    print("=" * 100)

    # Show a subset of columns for preview
    preview_cols = ['facilityName', 'facilityType', 'directorName', 'numberOfDoctors', 'numberOfBeds', 'city']
    available_preview_cols = [col for col in preview_cols if col in df.columns]

    print(df[available_preview_cols].head().to_string(index=False))
else:
    print("No health facilities to export")
#+end_src

* 15. Delete a Facility (Caution)

#+NAME: delete-facility
#+begin_src python
# WARNING: This will delete a facility!
# Uncomment to use

# facility_id_to_delete = "YOUR-FACILITY-ID-HERE"
# response = requests.delete(f"{BASE_URL}/HealthFacility/{facility_id_to_delete}")

# if response.status_code == 200:
#     print(f"‚úÖ Facility {facility_id_to_delete} deleted successfully")
# else:
#     print(f"‚ùå Error: {response.status_code}")
#     print(response.text)

print("‚ö†Ô∏è  Delete function is commented out for safety")
print("Uncomment the code above to enable deletion")
print("\nBest Practice: Instead of deleting, consider adding an 'isActive' flag")
print("to mark facilities as inactive while preserving historical data.")
#+end_src

* Summary

This demonstration covered the complete workflow for creating a new registry in Sunbird RC:

** Part 1: Schema Creation & Deployment
- ‚úÖ *Step 1:* Check registry health and confirm services are running
- ‚úÖ *Step 2:* Define JSON Schema for HealthFacility entity
  - Defined 20+ fields including facility info, staff capacity, services
  - Set required fields and data types
  - Added validation rules and enums
- ‚úÖ *Step 3:* Save schema as HealthFacility.json
- ‚úÖ *Step 4:* Deploy schema to Sunbird RC
  - Copy to =java/registry/src/main/resources/public/_schemas/=
  - Restart registry service to load schema
- ‚úÖ *Step 5:* Verify schema is available via API

** Part 2: Registry Operations
Created a complete Health Facilities registry with:
- ‚úÖ Facility identification (name, registration number, type)
- ‚úÖ Administrative details (director, staff capacity)
- ‚úÖ Operational information (beds, ICU, emergency services)
- ‚úÖ Service offerings and specializations
- ‚úÖ Location and contact information
- ‚úÖ Accreditation status

** Performed Operations:
- ‚úÖ Created multiple facility types (Government, Private, NGO)
- ‚úÖ Listed all facilities with key attributes
- ‚úÖ Searched by facility type and capabilities
- ‚úÖ Retrieved detailed facility information
- ‚úÖ Updated facility records
- ‚úÖ Generated comprehensive statistics
- ‚úÖ Bulk facility creation
- ‚úÖ Data export to CSV

** Use Cases Demonstrated:
- Hospital network management
- Healthcare capacity planning
- Resource allocation analysis
- Accreditation tracking
- Public health monitoring

** Key Learnings:

*** How to Create a New Registry in Sunbird RC:

1. *Design Your Schema*
   - Identify the entity type (e.g., HealthFacility)
   - Define all required and optional fields
   - Set data types, validations, and constraints
   - Follow JSON Schema format

2. *Create Schema File*
   - Name it after your entity (e.g., HealthFacility.json)
   - Include all field definitions
   - Add descriptions for documentation

3. *Deploy Schema*
   - Copy to schemas directory
   - Restart registry service
   - Verify via API endpoint

4. *Use the Registry*
   - POST to create entities
   - GET to retrieve entities
   - PUT to update entities
   - POST to /search for queries
   - DELETE to remove entities

** Next Steps for Extending This Registry:
- Add facility performance metrics
- Implement bed occupancy tracking
- Add equipment inventory management
- Create facility rating system
- Integrate with doctor and staff registries
- Add service quality indicators
- Implement facility inspection records
- Add emergency response capacity tracking
- Create public health reporting dashboards

** Creating Other Registry Types:

You can use the same workflow to create registries for:
- *Educational Institutions* (schools, colleges, universities)
- *Business Licenses* (permits, certifications, registrations)
- *Vehicle Registration* (cars, bikes, commercial vehicles)
- *Property Records* (land, buildings, real estate)
- *Professional Credentials* (doctors, lawyers, engineers)
- *Agricultural Records* (farms, crops, livestock)
- *Environmental Monitoring* (air quality, water quality, pollution)
- *Supply Chain* (suppliers, products, shipments)

Each registry follows the same pattern:
1. Define schema
2. Deploy to Sunbird RC
3. Create, read, update, search entities
4. Export and analyze data

For more information, see [[file:SETUP_GUIDE.md][SETUP_GUIDE.md]]
